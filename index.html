<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSI EMA70 / EMA200 Cross Scanner â€” 15m Futures</title>
  <style>
    body { font-family: monospace; background: #0b0c10; color: #eee; padding: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 6px 8px; text-align: left; }
    th { background: #1f2833; }
    .bullish { color: #00ff88; font-weight: bold; }
    .bearish { color: #ff5555; font-weight: bold; }
    .loading { color: #aaa; }
  </style>
</head>
<body>
  <h2>ðŸš€ RSI EMA70 / EMA200 Cross Scanner â€” 15 min Binance Futures USDT</h2>
  <p id="status" class="loading">Fetching symbols...</p>
  <table>
    <thead>
      <tr><th>Symbol</th><th>Signal</th><th>Time</th><th>Minutes Ago</th></tr>
    </thead>
    <tbody id="results"></tbody>
  </table>

<script>
const proxy = 'https://api.allorigins.win/raw?url=';

/* ---------- EMA ---------- */
function calculateEMA(data, period) {
  const k = 2 / (period + 1);
  const ema = [];
  let prevEma = null;
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) { ema.push(NaN); continue; }
    if (i === period - 1) {
      const sma = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
      prevEma = sma;
    }
    if (prevEma !== null) {
      const currEma = data[i] * k + prevEma * (1 - k);
      ema.push(currEma);
      prevEma = currEma;
    }
  }
  return ema;
}

/* ---------- RSI ---------- */
function calculateRSI(closes, period = 14) {
  if (!Array.isArray(closes) || closes.length <= period) return [];
  const rsi = [];
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = closes[i] - closes[i - 1];
    if (diff > 0) gains += diff; else losses -= diff;
  }
  let avgGain = gains / period;
  let avgLoss = losses / period;
  let rs = avgLoss === 0 ? Infinity : avgGain / avgLoss;
  rsi[period] = 100 - 100 / (1 + rs);
  for (let i = period + 1; i < closes.length; i++) {
    const diff = closes[i] - closes[i - 1];
    const gain = diff > 0 ? diff : 0;
    const loss = diff < 0 ? -diff : 0;
    avgGain = (avgGain * (period - 1) + gain) / period;
    avgLoss = (avgLoss * (period - 1) + loss) / period;
    rs = avgLoss === 0 ? Infinity : avgGain / avgLoss;
    rsi[i] = 100 - 100 / (1 + rs);
  }
  for (let i = 0; i < period; i++) rsi[i] = NaN;
  return rsi;
}

/* ---------- Detect Recent RSI Cross ---------- */
function detectRecentRSICross(rsi, ema70, ema200) {
  const len = rsi.length;
  const lookback = 3; // last 3 candles (~45 min)
  for (let i = len - lookback; i < len; i++) {
    const prevRSI = rsi[i - 1], currRSI = rsi[i];
    const prev70 = ema70[i - 1], curr70 = ema70[i];
    const prev200 = ema200[i - 1], curr200 = ema200[i];
    if (prevRSI <= prev70 && prevRSI <= prev200 &&
        currRSI > curr70 && currRSI > curr200) {
      return { type: 'bullish', index: i };
    }
    if (prevRSI >= prev70 && prevRSI >= prev200 &&
        currRSI < curr70 && currRSI < curr200) {
      return { type: 'bearish', index: i };
    }
  }
  return null;
}

/* ---------- Fetch Data ---------- */
async function fetchSymbols() {
  const res = await fetch(proxy + encodeURIComponent('https://fapi.binance.com/fapi/v1/exchangeInfo'));
  const data = await res.json();
  return data.symbols
    .filter(s => s.symbol.endsWith('USDT') && s.contractType === 'PERPETUAL')
    .map(s => s.symbol);
}

async function fetchKlines(symbol) {
  const url = proxy + encodeURIComponent(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=500`);
  const res = await fetch(url);
  const data = await res.json();
  return data.map(c => ({
    time: c[0],
    close: +c[4]
  }));
}

/* ---------- Main Scanner ---------- */
(async () => {
  const status = document.getElementById('status');
  const tbody = document.getElementById('results');
  const symbols = await fetchSymbols();
  status.textContent = `Scanning ${symbols.length} pairs...`;

  const BATCH_SIZE = 5;
  const MIN_DELAY = 400, MAX_DELAY = 800;
  let count = 0;

  for (let sym of symbols) {
    try {
      const candles = await fetchKlines(sym);
      const closes = candles.map(c => c.close);
      const rsi = calculateRSI(closes, 14);
      const ema70 = calculateEMA(rsi, 70);
      const ema200 = calculateEMA(rsi, 200);
      const cross = detectRecentRSICross(rsi, ema70, ema200);

      if (cross) {
        const candle = candles[cross.index];
        const minsAgo = ((Date.now() - candle.time) / 60000).toFixed(1);
        if (minsAgo <= 45) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${sym}</td>
            <td class="${cross.type}">${cross.type.toUpperCase()}</td>
            <td>${new Date(candle.time).toLocaleString()}</td>
            <td>${minsAgo}</td>
          `;
          tbody.appendChild(row);
        }
      }
    } catch (err) {
      console.error(sym, err);
    }

    count++;
    if (count % BATCH_SIZE === 0)
      await new Promise(r => setTimeout(r, 2000));
    await new Promise(r => setTimeout(r, Math.random() * (MAX_DELAY - MIN_DELAY) + MIN_DELAY));
  }

  status.textContent = `âœ… Scan complete!`;
})();
</script>
</body>
</html>
